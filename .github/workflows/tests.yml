name: Rust Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  linux-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    # - name: Run tests
    #   run: cargo test --lib --verbose --no-run
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  linux-ipv4:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Configure test network interfaces
      run: |
        sudo ip addr add 192.168.0.6/24 dev lo
        sudo ip addr add 192.168.0.7/24 dev lo
        sudo ip addr add 192.168.0.8/24 dev lo
        sudo ip link set dev lo up
        ip addr show dev lo
    - name: Run ipv4 tests
      run: cargo test ipv4 -- --ignored --test-threads=1 --no-capture

  windows-tests:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  windows-ipv4:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install devcon
      shell: powershell
      run: choco install devcon.portable -y
    - name: Configure IP
      shell: powershell
      run: |
        Import-Module "$env:ChocolateyInstall/helpers/chocolateyInstaller.psm1"
        refreshenv
        $ips = @("192.168.0.6","192.168.0.7","192.168.0.8")
        $devcon = (Get-Command devcon64.exe).Source
        # Create three Microsoft KM-TEST Loopback Adapters
        1..3 | ForEach-Object {
          & $devcon install "$env:WINDIR\Inf\netloop.inf" *msloop
        }
        echo "waiting..."
        Start-Sleep -Seconds 5
        echo "get adapters..."
        # Grab the new adapters, rename them, and assign one IP each
        $loopbacks = Get-NetAdapter | Where {$_.InterfaceDescription -like "*Loopback*"} | Sort-Object ifIndex
        Get-NetIPAddress -AddressFamily IPv4
        Start-Sleep -Seconds 5
        if ($loopbacks.Count -lt 3) { throw "Expected 3 loopback adapters, found $($loopbacks.Count)" }

        for ($i = 0; $i -lt 3; $i++) {
          $alias = "Loopback$($i+1)"
          Rename-NetAdapter -Name $loopbacks[$i].Name -NewName $alias
          Set-NetConnectionProfile -InterfaceAlias $alias -NetworkCategory Private
          # Assign /24 on each NIC (adjust as needed)
          New-NetIPAddress -InterfaceAlias $alias -IPAddress $ips[$i] -PrefixLength 24 | Out-Null
        }
        Start-Sleep -Seconds 3

        Write-Host "Configured:"
        Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "Loopback*"} | Format-Table InterfaceAlias,IPAddress,PrefixLength
    - name: Run tests
      shell: powershell
      env:
        RUST_BACKTRACE: 1
        RUST_LOG: trace
      run: cargo test test_ansi_e131_appendix_b_runthrough_ipv4 -- --ignored --no-capture --test-threads=1
