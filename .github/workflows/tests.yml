name: Rust Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  linux-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    # - name: Run tests
    #   run: cargo test --lib --verbose --no-run
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  linux-ipv4:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Configure test network interfaces
      run: |
        sudo ip addr add 192.168.0.6/24 dev lo
        sudo ip addr add 192.168.0.7/24 dev lo
        sudo ip addr add 192.168.0.8/24 dev lo
        sudo ip link set dev lo up
        ip addr show dev lo
    - name: Run ipv4 tests
      run: cargo test test_ansi_e131_appendix_b_runthrough_ipv4 -- --ignored --test-threads=1 --no-capture --nocapture

  windows-tests:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  windows-ipv4:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install devcon
      shell: powershell
      run: choco install devcon.portable -y
    - name: Configure IP
      shell: powershell
      run: ./scripts/setup-loopback-ints.ps1

    - name: Run tests
      shell: powershell
      env:
        RUST_BACKTRACE: 1
        RUST_LOG: trace
      run: cargo test test_ansi_e131_appendix_b_runthrough_ipv4 -- --ignored --nocapture --no-capture --test-threads=1
