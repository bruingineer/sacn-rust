name: Rust Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  linux-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    # - name: Run tests
    #   run: cargo test --lib --verbose --no-run
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  linux-ipv4:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Configure test network interfaces
      run: |
        sudo ip addr add 192.168.0.6/24 dev eth0
        sudo ip addr add 192.168.0.7/24 dev eth0
        sudo ip addr add 192.168.0.8/24 dev eth0
        sudo ip link set dev lo up
    - name: Run ipv4 tests
      run: cargo test ipv4 -- --ignored --test-threads=1 --no-capture

  windows-tests:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    # - name: Run tests
    #   run: cargo test --lib --verbose --no-run
    - name: Run integration tests
      run: |
        cargo test --lib --no-run
        cargo test --test "*" -- --no-capture --test-threads=1
        cargo test --doc

  windows-ipv4:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Configure IP
      shell: powershell
      run: |
        $ip1="192.168.0.6"
        $ip2="192.168.0.7"
        $ip3="192.168.0.8"
        $prefixLength=24
        $adapter = Get-NetAdapter | Where {$_.Name -like "Eth*"} | select -first 1
        echo $adapter
        New-NetIPAddress -InterfaceAlias $adapter.Name -IPAddress $ip1 -PrefixLength $prefixLength
        New-NetIPAddress -InterfaceAlias $adapter.Name -IPAddress $ip2 -PrefixLength $prefixLength
        New-NetIPAddress -InterfaceAlias $adapter.Name -IPAddress $ip3 -PrefixLength $prefixLength
        echo "configed IP"
      # ./docker-ipv4-test/scripts/configure-ip.ps1
      # ./docker-ipv4-test/scripts/run-tests.ps1
    - name: Run tests
      shell: powershell
      run: cargo test ipv4 -- --ignored --no-capture --test-threads=1

  # windows-ipv4:
  #   runs-on: windows-2022
    
  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Build test container
  #     shell: powershell
  #     run: docker build --file docker-ipv4-test/Dockerfile --isolation=hyperv -t ipv4-test . #|
  #   # cd docker-ipv4-test
  #   #    docker build --file docker-ipv4-test/Dockerfile --isolation=hyperv -t ipv4-test .
    
  #   - name: Run tests in container
  #     shell: powershell
  #     run: |
  #       docker run --rm `
  #         --isolation=hyperv `
  #         -e IP_ADDRESS_1=192.168.0.6 `
  #         -e IP_ADDRESS_2=192.168.0.7 `
  #         -e IP_ADDRESS_3=192.168.0.8 `
  #         -e PREFIX_LENGTH=24 `
  #         ipv4-test